<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Bookstore.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tarefa2-incompleta</a> &gt; <a href="index.source.html" class="el_package">inf300.servico</a> &gt; <span class="el_source">Bookstore.java</span></div><h1>Bookstore.java</h1><pre class="source lang-java linenums">package inf300.servico;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Random;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import inf300.dominio.Address;
import inf300.dominio.Author;
import inf300.dominio.Book;
import inf300.dominio.CCTransaction;
import inf300.dominio.Cart;
import inf300.dominio.Country;
import inf300.dominio.Customer;
import inf300.dominio.Order;
import inf300.dominio.OrderLine;
import inf300.util.Populator;
import inf300.util.TPCW_Util;

/**
 * *&lt;img src=&quot;./doc-files/Bookstore.png&quot; alt=&quot;Bookstore&quot;&gt;
 */
public class Bookstore implements Serializable {

    private static final long serialVersionUID = -3099048826035606338L;
    private static Bookstore instance;

    private boolean populated;
    private final List&lt;Country&gt; countryById;
    private final Map&lt;String, Country&gt; countryByName;
    private final List&lt;Address&gt; addressById;
    private final Map&lt;Address, Address&gt; addressByAll;
    private final List&lt;Customer&gt; customersById;
    private final Map&lt;String, Customer&gt; customersByUsername;
    private final List&lt;Author&gt; authorsById;
    private final List&lt;Book&gt; booksById;
    private final List&lt;Cart&gt; cartsById;
    private final List&lt;Order&gt; ordersById;
    private final LinkedList&lt;Order&gt; ordersByCreation;

    /**
     * &lt;pre&gt;
     *         populated = false;
     *         countryById = new ArrayList&amp;lt;&amp;gt;();
     *         countryByName = new HashMap&amp;lt;&amp;gt;();
     *         addressById = new ArrayList&amp;lt;&amp;gt;();
     *         addressByAll = new HashMap&amp;lt;&amp;gt;();
     *         customersById = new ArrayList&amp;lt;&amp;gt;();
     *         customersByUsername = new HashMap&amp;lt;&amp;gt;();
     *         authorsById = new ArrayList&amp;lt;&amp;gt;();
     *         booksById = new ArrayList&amp;lt;&amp;gt;();
     *         cartsById = new ArrayList&amp;lt;&amp;gt;();
     *         ordersById = new ArrayList&amp;lt;&amp;gt;();
     *         ordersByCreation = new LinkedList&amp;lt;&amp;gt;();
     * &lt;/pre&gt;
     */
<span class="fc" id="L72">    private Bookstore() {</span>
<span class="fc" id="L73">        countryById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L74">        countryByName = new HashMap&lt;&gt;();</span>
<span class="fc" id="L75">        addressById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L76">        addressByAll = new HashMap&lt;&gt;();</span>
<span class="fc" id="L77">        customersById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L78">        customersByUsername = new HashMap&lt;&gt;();</span>
<span class="fc" id="L79">        authorsById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L80">        booksById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L81">        cartsById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L82">        ordersById = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L83">        ordersByCreation = new LinkedList&lt;&gt;();</span>

<span class="fc" id="L85">    }</span>

    public synchronized static Bookstore getInstance() {
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (instance == null) {</span>
<span class="fc" id="L89">            instance = new Bookstore();</span>
        }
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (!instance.populated) {</span>
<span class="fc" id="L92">            long seed = 0;</span>
<span class="fc" id="L93">            long now = System.currentTimeMillis();</span>
<span class="fc" id="L94">            int items = 100000;</span>
<span class="fc" id="L95">            int customers = 1000;</span>
<span class="fc" id="L96">            int addresses = 1000;</span>
<span class="fc" id="L97">            int authors = 100;</span>
<span class="fc" id="L98">            int orders = 100000;</span>
<span class="fc" id="L99">            new Populator(instance).populate(seed, now, items, customers, addresses, authors, orders);</span>
<span class="fc" id="L100">            instance.populated = true;</span>
        }
<span class="fc" id="L102">        return instance;</span>
    }

    public List&lt;Book&gt; getBooksById() {
<span class="fc" id="L106">        return booksById;</span>
    }

    /**
     *
     * @return
     */
    public boolean isPopulated() {
<span class="fc" id="L114">        return populated;</span>
    }

    public void setPopulated(boolean populated) {
<span class="fc" id="L118">        this.populated = populated;</span>
<span class="fc" id="L119">    }</span>

    /**
     * &lt;pre&gt;
     *         Country country = countryByName.get(name);
     *         if (country == null) {
     *             country = createCountry(name, &quot;&quot;, 0);
     *         }
     *         return country;
     * &lt;/pre&gt;
     *
     * @param name
     * @return
     */
    private Country alwaysGetCountry(String name) {
<span class="fc" id="L134">        Country country = countryByName.get(name);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        if (country == null) {</span>
<span class="fc" id="L136">            country = createCountry(name, &quot;&quot;, 0);</span>
        }
<span class="fc" id="L138">        return country;</span>
    }

    /**
     * return countryById.get(random.nextInt(countryById.size()));
     *
     * @param random
     * @return
     */
    public Country getACountryAnyCountry(Random random) {
<span class="fc" id="L148">        return countryById.get(random.nextInt(countryById.size()));</span>
    }

    public Country getCountryByName(String countryName) {
<span class="fc" id="L152">        Optional&lt;Country&gt; opC = countryById.stream().filter(c -&gt; c.getName().toUpperCase().equals(countryName.toUpperCase())).findFirst();</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">        return opC.isPresent() ? opC.get() : null;</span>
    }

    /**
     * &lt;pre&gt;
     * int id = countryById.size();
     * Country country = new Country(id, name, currency, exchange);
     * countryById.add(country);
     * countryByName.put(name, country);
     * return country;
     * &lt;/pre&gt;
     *
     * @param name
     * @param currency
     * @param exchange
     * @return
     */
    public Country createCountry(String name, String currency, double exchange) {
<span class="fc" id="L171">        int id = countryById.size();</span>
<span class="fc" id="L172">        Country country = new Country(id, name, currency, exchange);</span>
<span class="fc" id="L173">        countryById.add(country);</span>
<span class="fc" id="L174">        countryByName.put(name, country);</span>
<span class="fc" id="L175">        return country;</span>
    }

    /**
     * &lt;pre&gt;
     * Country country = alwaysGetCountry(countryName);
     * Address key = new Address(0, street1, street2, city, state, zip, country);
     * Address address = addressByAll.get(key);
     * if (address == null) {
     *  address = createAddress(street1, street2, city, state, zip, country);
     * }
     * return address;
     * &lt;/pre&gt;
     *
     * @param street1
     * @param street2
     * @param city
     * @param state
     * @param zip
     * @param countryName
     * @return
     */
    public Address alwaysGetAddress(String street1, String street2,
            String city, String state, String zip, String countryName,
            String latitude, String longitude, String buildingNumber) {
<span class="fc" id="L200">        Country country = alwaysGetCountry(countryName);</span>
<span class="fc" id="L201">        Address key = new Address(0, street1, street2, city, state, zip, country,</span>
         latitude, longitude,  buildingNumber);
<span class="fc" id="L203">        Address address = addressByAll.get(key);</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">        if (address == null) {</span>
<span class="fc" id="L205">            address = createAddress(street1, street2, city, state, zip,</span>
                    country, latitude, longitude, buildingNumber);
        }
<span class="fc" id="L208">        return address;</span>
    }

    /**
     *
     * @param random
     * @return
     */
    public Address getAnAddressAnyAddress(Random random) {
<span class="fc" id="L217">        return addressById.get(random.nextInt(addressById.size()));</span>
    }

    public Address createAddress(String street1, String street2,
            String city, String state, String zip, Country country, 
            String latitude, String longitude, String buildingNumber) {
<span class="fc" id="L223">        int id = addressById.size();</span>
<span class="fc" id="L224">        Address address = new Address(id, street1, street2, city, state, zip, country, latitude, longitude, buildingNumber);</span>
<span class="fc" id="L225">        addressById.add(address);</span>
<span class="fc" id="L226">        addressByAll.put(address, address);</span>
<span class="fc" id="L227">        return address;</span>
    }

    /**
     *
     * @param cId
     * @return
     */
    public Customer getCustomer(int cId) {
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        return (cId &gt;= customersById.size()) ? null : customersById.get(cId);</span>
    }

    /**
     *
     * @param username
     * @return
     */
    public Optional&lt;Customer&gt; getCustomer(String username) {
<span class="fc" id="L245">        return Optional.ofNullable(customersByUsername.get(username));</span>
    }

    public Customer getACustomerAnyCustomer(Random random) {
<span class="fc" id="L249">        return customersById.get(random.nextInt(customersById.size()));</span>
    }

    /**
     * &lt;pre&gt;
     * Address address = alwaysGetAddress(street1, street2, city, state, zip,
     * countryName);
     * return createCustomer(fname, lname, address, phone, email,
     * new Date(now), new Date(now), new Date(now),
     * new Date(now + 7200000 ), discount, birthdate,
     * data);
     * &lt;/pre&gt;
     *
     * @param fname
     * @param lname
     * @param street1
     * @param street2
     * @param city
     * @param state
     * @param zip
     * @param countryName
     * @param phone
     * @param email
     * @param discount
     * @param birthdate
     * @param data
     * @param now
     * @return
     */
    public Customer createCustomer(String fname, String lname, String street1,
            String street2, String city, String state, String zip,
            String countryName, String latitude, String longitude, 
            String buildingNumber, String phone, String email, double discount,
            Date birthdate, String data, long now) {
<span class="fc" id="L283">        Address address = alwaysGetAddress(street1, street2, city, state, zip,</span>
                countryName, latitude,  longitude, buildingNumber);
<span class="fc" id="L285">        return createCustomer(fname, lname, address, phone, email,</span>
                new Date(now), new Date(now), new Date(now),
                new Date(now + 7200000 /* 2 hours */), discount, birthdate,
                data);
    }

    /**
     * &lt;pre&gt;
     *  int id = customersById.size();
     * String uname = TPCW_Util.DigSyl(id, 0);
     * Customer customer = new Customer(id, uname, uname.toLowerCase(), fname,
     * lname, phone, email, since, lastVisit, login, expiration,
     * discount, 0, 0, birthdate, data, address);
     * customersById.add(customer);
     * customersByUsername.put(uname, customer);
     * return customer;
     * &lt;/pre&gt;
     *
     * @param fname
     * @param lname
     * @param address
     * @param phone
     * @param email
     * @param since
     * @param lastVisit
     * @param login
     * @param expiration
     * @param discount
     * @param birthdate
     * @param data
     * @return
     */
    public Customer createCustomer(String fname, String lname, Address address,
            String phone, String email, Date since, Date lastVisit,
            Date login, Date expiration, double discount, Date birthdate,
            String data) {
<span class="fc" id="L321">        int id = customersById.size();</span>
<span class="fc" id="L322">        String uname = TPCW_Util.DigSyl(id, 0);</span>
<span class="fc" id="L323">        Customer customer = new Customer(id, uname, uname.toLowerCase(), fname,</span>
                lname, phone, email, since, lastVisit, login, expiration,
                discount, 0, 0, birthdate, data, address);
<span class="fc" id="L326">        customersById.add(customer);</span>
<span class="fc" id="L327">        customersByUsername.put(uname, customer);</span>
<span class="fc" id="L328">        return customer;</span>
    }

    /**
     * &lt;pre&gt;
     * Customer customer = getCustomer(cId);
     * if (customer != null) {
     * customer.setLogin(new Date(now));
     * customer.setExpiration(new Date(now + 7200000 ));
     * }
     * &lt;/pre&gt;
     *
     * @param cId
     * @param now
     */
    public void refreshCustomerSession(int cId, long now) {
<span class="fc" id="L344">        Customer customer = getCustomer(cId);</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        if (customer != null) {</span>
<span class="fc" id="L346">            customer.setLogin(new Date(now));</span>
<span class="fc" id="L347">            customer.setExpiration(new Date(now + 7200000 /* 2 hours */));</span>
        }
<span class="fc" id="L349">    }</span>

    public Author getAnAuthorAnyAuthor(Random random) {
<span class="fc" id="L352">        return authorsById.get(random.nextInt(authorsById.size()));</span>
    }

    public Author createAuthor(String fname, String mname, String lname,
            Date birthdate, String bio) {
<span class="fc" id="L357">        Author author = new Author(fname, mname, lname, birthdate, bio);</span>
<span class="fc" id="L358">        authorsById.add(author);</span>
<span class="fc" id="L359">        return author;</span>
    }

    /**
     *
     * @param bId
     * @return
     */
    public Optional&lt;Book&gt; getBook(int bId) {
<span class="fc" id="L368">        return Optional.ofNullable(booksById.get(bId));</span>
    }

    public Book getABookAnyBook(Random random) {
<span class="fc" id="L372">        return booksById.get(random.nextInt(booksById.size()));</span>
    }

    /**
     * &lt;pre&gt;
     * ArrayList&amp;lt;Book&amp;gt; books = new ArrayList&amp;lt;&amp;gt;();
     * for (Book book : booksById) {
     * if (subject.equals(book.getSubject())) {
     * books.add(book);
     * if (books.size() &amp;gt; 50) {
     * break;
     * }
     * }
     * }
     * Collections.sort(books, (Book a, Book b) -&amp;gt; a.getTitle().compareTo(b.getTitle()));
     * return books;
     * &lt;/pre&gt;
     *
     * @param subject
     * @return
     */
    public List&lt;Book&gt; getBooksBySubject(String subject) {
<span class="fc" id="L394">        ArrayList&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">        for (Book book : booksById) {</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">            if (subject.equals(book.getSubject())) {</span>
<span class="fc" id="L397">                books.add(book);</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">                if (books.size() &gt; 50) {</span>
<span class="fc" id="L399">                    break;</span>
                }
            }
<span class="fc" id="L402">        }</span>
<span class="fc" id="L403">        Collections.sort(books, (Book a, Book b) -&gt; a.getTitle().compareTo(b.getTitle()));</span>
<span class="fc" id="L404">        return books;</span>
    }

    /**
     *
     * @param title
     * @return
     */
    public List&lt;Book&gt; getBooksByTitle(String title) {
<span class="fc" id="L413">        Pattern regex = Pattern.compile(&quot;^&quot; + title);</span>
<span class="fc" id="L414">        ArrayList&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        for (Book book : booksById) {</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">            if (regex.matcher(book.getTitle()).matches()) {</span>
<span class="nc" id="L417">                books.add(book);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                if (books.size() &gt; 50) {</span>
<span class="nc" id="L419">                    break;</span>
                }
            }
<span class="fc" id="L422">        }</span>
<span class="pc" id="L423">        Collections.sort(books, (Book a, Book b) -&gt; a.getTitle().compareTo(b.getTitle()));</span>
<span class="fc" id="L424">        return books;</span>
    }

    /**
     *
     * @param author
     * @return
     */
    public List&lt;Book&gt; getBooksByAuthor(String author) {
<span class="fc" id="L433">        Pattern regex = Pattern.compile(&quot;^&quot; + author);</span>
<span class="fc" id="L434">        ArrayList&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L435" title="1 of 2 branches missed.">        for (Book book : booksById) {</span>
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">            if (regex.matcher(book.getAuthor().getLname()).matches()) {</span>
<span class="fc" id="L437">                books.add(book);</span>
<span class="fc bfc" id="L438" title="All 2 branches covered.">                if (books.size() &gt; 50) {</span>
<span class="fc" id="L439">                    break;</span>
                }
            }
<span class="fc" id="L442">        }</span>
<span class="fc" id="L443">        Collections.sort(books, (Book a, Book b) -&gt; a.getTitle().compareTo(b.getTitle()));</span>
<span class="fc" id="L444">        return books;</span>
    }

    /**
     * Retorna os 50 livros mais recentes (PubDate) por assunto
     *
     * @param subject
     * @return
     */
    public List&lt;Book&gt; getNewBooks(String subject) {
<span class="fc" id="L454">        return getNewBooks0(subject);</span>
    }

    /**
     *
     * @param subject
     * @return
     */
    List&lt;Book&gt; getNewBooks0(String subject) {
<span class="fc" id="L463">        ArrayList&lt;Book&gt; books = new ArrayList&lt;Book&gt;();</span>
<span class="fc bfc" id="L464" title="All 2 branches covered.">        for (Book book : booksById) {</span>
<span class="fc bfc" id="L465" title="All 2 branches covered.">            if (subject.equals(book.getSubject())) {</span>
<span class="fc" id="L466">                books.add(book);</span>
            }
<span class="fc" id="L468">        }</span>
<span class="fc" id="L469">        Collections.sort(books, new Comparator&lt;Book&gt;() {</span>
            public int compare(Book a, Book b) {
<span class="fc" id="L471">                int result = b.getPubDate().compareTo(a.getPubDate());</span>
<span class="fc bfc" id="L472" title="All 2 branches covered.">                if (result == 0) {</span>
<span class="fc" id="L473">                    result = a.getTitle().compareTo(b.getTitle());</span>
                }
<span class="fc" id="L475">                return result;</span>
            }
        });
<span class="pc bpc" id="L478" title="1 of 2 branches missed.">        return books.subList(0, books.size() &gt;= 50 ? 50 : books.size());</span>
    }

    List&lt;Book&gt; getNewBooks1(String subject) {
<span class="nc" id="L482">        ArrayList&lt;Book&gt; books = new ArrayList&lt;Book&gt;();</span>

<span class="nc" id="L484">        booksById.stream().forEach(book -&gt; {</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">            if (subject.equals(book.getSubject())) {</span>
<span class="nc" id="L486">                books.add(book);</span>
            }
<span class="nc" id="L488">        });</span>

<span class="nc" id="L490">        return books.stream().sorted((a, b) -&gt; {</span>
<span class="nc" id="L491">            int result = b.getPubDate().compareTo(a.getPubDate());</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">            if (result == 0) {</span>
<span class="nc" id="L493">                result = a.getTitle().compareTo(b.getTitle());</span>
            }
<span class="nc" id="L495">            return result;</span>
<span class="nc" id="L496">        }).limit(50).collect(Collectors.toList());</span>
    }

    /**
     *
     * @param subject
     * @return
     */
    List&lt;Book&gt; getNewBooks2(String subject) {
<span class="fc" id="L505">        List&lt;Book&gt; books = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L506">        booksById.stream()</span>
<span class="fc" id="L507">                .filter((book) -&gt; (subject.equals(book.getSubject())))</span>
<span class="fc" id="L508">                .forEachOrdered((book) -&gt; {</span>
<span class="fc" id="L509">                    books.add(book);</span>
<span class="fc" id="L510">                });</span>
<span class="fc" id="L511">        Collections.sort(books, (Book a, Book b) -&gt; {</span>
<span class="fc" id="L512">            int result = b.getPubDate().compareTo(a.getPubDate());</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">            if (result == 0) {</span>
<span class="fc" id="L514">                result = a.getTitle().compareTo(b.getTitle());</span>
            }
<span class="fc" id="L516">            return result;</span>
        });
<span class="pc bpc" id="L518" title="1 of 2 branches missed.">        return books.subList(0, books.size() &gt;= 50 ? 50 : books.size());</span>
    }

    /**
     *
     * @param subject
     * @return
     */
    List&lt;Book&gt; getNewBooks3(String subject) {
<span class="fc" id="L527">        return booksById.stream()</span>
<span class="fc" id="L528">                .filter((book) -&gt; (subject.equals(book.getSubject())))</span>
<span class="fc" id="L529">                .sorted((Book a, Book b) -&gt; {</span>
<span class="fc" id="L530">                    int result = b.getPubDate().compareTo(a.getPubDate());</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">                    if (result == 0) {</span>
<span class="fc" id="L532">                        result = a.getTitle().compareTo(b.getTitle());</span>
                    }
<span class="fc" id="L534">                    return result;</span>
<span class="fc" id="L535">                }).limit(50)</span>
<span class="fc" id="L536">                .collect(Collectors.toList());</span>

    }

    /**
     *
     * @param subject
     * @return
     */
    List&lt;Book&gt; getNewBooks4(String subject) {
<span class="fc" id="L546">        return booksById.parallelStream()</span>
<span class="fc" id="L547">                .filter((book) -&gt; (subject.equals(book.getSubject())))</span>
<span class="fc" id="L548">                .sorted((Book a, Book b) -&gt; {</span>
<span class="fc" id="L549">                    int result = b.getPubDate().compareTo(a.getPubDate());</span>
<span class="fc bfc" id="L550" title="All 2 branches covered.">                    if (result == 0) {</span>
<span class="fc" id="L551">                        result = a.getTitle().compareTo(b.getTitle());</span>
                    }
<span class="fc" id="L553">                    return result;</span>
<span class="fc" id="L554">                }).limit(50)</span>
<span class="fc" id="L555">                .collect(Collectors.toList());</span>
    }

    /**
     *
     */
    public static class Counter {

        /**
         *
         */
        public final Book book;
        public int count;

<span class="nc" id="L569">        public Counter(Book book, int count) {</span>
<span class="nc" id="L570">            this.book = book;</span>
<span class="nc" id="L571">            this.count = count;</span>
<span class="nc" id="L572">        }</span>
        
        

        public Book getBook() {
<span class="nc" id="L577">            return this.book;</span>
        }

        /**
         *
         */
        public int getCounter() {
<span class="nc" id="L584">            return this.count;</span>
        }
    }

    /**
     * &lt;b&gt;&lt;u&gt;Tarefa: desenvolver o método getBestSellers. &lt;/u&gt;&lt;/b&gt;&lt;br&gt;&lt;br&gt;
     *  1 - Desenvolver o método
     * que busca os 50 livros mais vendidos &quot;bestsellers&quot; para um determinado
     * assunto (subject).&lt;br&gt; 2 - Desenvolver o teste funcional do método.&lt;br&gt;
     *
     *
     * @param subject
     * @return
     */
    public List&lt;Book&gt; getBestSellers(final String subject) {
    	
<span class="fc" id="L600"> HashMap&lt;Book,Integer&gt; sellCounter = new HashMap&lt;Book,Integer&gt;();</span>
<span class="fc" id="L601"> List&lt;Book&gt; books = Bookstore.getInstance().getBooksById();</span>
 
 
 int quantity;

<span class="fc bfc" id="L606" title="All 2 branches covered."> for(Book book : books) {</span>
<span class="fc" id="L607">	 quantity = 0;</span>
 
<span class="fc bfc" id="L609" title="All 2 branches covered.">	 if ( book.getSubject().equals(subject)) {</span>
<span class="fc bfc" id="L610" title="All 2 branches covered.">		for (Order order : ordersByCreation) {</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">			 if (order.getStatus().equals(&quot;SHIPPED&quot;)){				 				 </span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">		         for (OrderLine line : order.getLines()) {</span>
<span class="fc bfc" id="L613" title="All 2 branches covered.">			       if (line.getBook().equals(book)) {</span>
<span class="fc" id="L614">			    	   quantity += line.getQty();</span>
			       }
<span class="fc" id="L616">		         }</span>
			 } 
<span class="fc" id="L618">		 }</span>
<span class="fc" id="L619">		 Integer value = sellCounter.get(book);</span>
<span class="pc bpc" id="L620" title="1 of 2 branches missed.">		 if (value != null) {</span>
<span class="nc" id="L621">			 sellCounter.put(book, value +quantity);</span>
		 }else {
<span class="fc" id="L623">			 sellCounter.put(book, quantity);</span>
		 }
		 
	 }
<span class="fc" id="L627"> }	 </span>

<span class="fc" id="L629">LinkedHashMap&lt;Book, Integer&gt; sorted =</span>
<span class="fc" id="L630">	sellCounter.entrySet()</span>
<span class="fc" id="L631">		.stream()</span>
<span class="fc" id="L632">		.sorted(Map.Entry.comparingByValue(Comparator.reverseOrder())).limit(50)</span>
<span class="fc" id="L633">        .collect(Collectors.toMap(e-&gt; e.getKey(), e-&gt; e.getValue(),</span>
<span class="nc" id="L634">        		(e1, e2) -&gt; null,</span>
<span class="fc" id="L635">        		() -&gt; new LinkedHashMap&lt;Book,Integer&gt;()));</span>
<span class="fc" id="L636">     System.out.println(sorted) ;</span>

<span class="fc" id="L638">List&lt;Book&gt; sortedList = new ArrayList&lt;&gt; (sorted.keySet());</span>

<span class="fc" id="L640">System.out.println(sortedList);</span>

<span class="fc" id="L642">return sortedList;</span>
        
	
 
 }
 	
       	
    
    /**
     *
     * @param subject
     * @return
     */
    public Book createBook(String title, Date pubDate, String publisher,
            String subject, String desc, String thumbnail,
            String image, double srp, double cost, Date avail, String isbn,
            int page, String backing, String dimensions, Author author,
            int stock) {
<span class="fc" id="L660">        int id = booksById.size();</span>
<span class="fc" id="L661">        Book book = new Book(id, title, pubDate, publisher, subject, desc,</span>
                thumbnail, image, srp, cost, avail, isbn, page, backing,
                dimensions, author, stock);
<span class="fc" id="L664">        booksById.add(book);</span>
<span class="fc" id="L665">        return book;</span>
    }

    /**
     *
     * @param bId
     * @param cost
     * @param image
     * @param thumbnail
     * @param now
     */
    public void updateBook(int bId, double cost, String image,
            String thumbnail, long now) {
<span class="fc" id="L678">        Book book = getBook(bId).get();</span>
<span class="fc" id="L679">        book.setCost(cost);</span>
<span class="fc" id="L680">        book.setImage(image);</span>
<span class="fc" id="L681">        book.setThumbnail(thumbnail);</span>
<span class="fc" id="L682">        book.setPubDate(new Date(now));</span>
<span class="fc" id="L683">        updateRelatedBooks(book);</span>
<span class="fc" id="L684">    }</span>

    /**
     * For all the clients that bought this book in the last 10000 orders, what
     * are the five most sold books except this one.
     */
    private void updateRelatedBooks(Book targetBook) {
<span class="fc" id="L691">        HashSet&lt;Integer&gt; clientIds = new HashSet&lt;&gt;();</span>
<span class="fc" id="L692">        int j = 0;</span>
<span class="fc" id="L693">        Iterator&lt;Order&gt; i = ordersByCreation.iterator();</span>
<span class="pc bpc" id="L694" title="1 of 4 branches missed.">        while (i.hasNext() &amp;&amp; j &lt;= 10000) {</span>
<span class="fc" id="L695">            Order order = i.next();</span>
<span class="fc bfc" id="L696" title="All 2 branches covered.">            for (OrderLine line : order.getLines()) {</span>
<span class="fc" id="L697">                Book book = line.getBook();</span>
<span class="pc bpc" id="L698" title="1 of 2 branches missed.">                if (targetBook.getId() == book.getId()) {</span>
<span class="nc" id="L699">                    clientIds.add(order.getCustomer().getId());</span>
<span class="nc" id="L700">                    break;</span>
                }
<span class="fc" id="L702">            }</span>
<span class="fc" id="L703">            j++;</span>
<span class="fc" id="L704">        }</span>
<span class="fc" id="L705">        HashMap&lt;Integer, Counter&gt; counters = new HashMap&lt;&gt;();</span>
<span class="fc" id="L706">        i = ordersByCreation.iterator();</span>
<span class="fc bfc" id="L707" title="All 2 branches covered.">        while (i.hasNext()) {</span>
<span class="fc" id="L708">            Order order = i.next();</span>
<span class="pc bpc" id="L709" title="1 of 2 branches missed.">            if (clientIds.contains(order.getCustomer().getId())) {</span>
<span class="nc" id="L710">                order.getLines().forEach((line) -&gt; {</span>
<span class="nc" id="L711">                    Book book = line.getBook();</span>
<span class="nc bnc" id="L712" title="All 2 branches missed.">                    if (targetBook.getId() != book.getId()) {</span>
<span class="nc" id="L713">                        Counter counter = counters.get(book.getId());</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">                        if (counter == null) {</span>
<span class="nc" id="L715">                            counter = new Counter(book, 0);</span>
<span class="nc" id="L716">                            counters.put(book.getId(), counter);</span>
                        }
<span class="nc" id="L718">                        counter.count += line.getQty();</span>
                    }
<span class="nc" id="L720">                });</span>
            }
<span class="fc" id="L722">        }</span>
<span class="fc" id="L723">        Counter[] sorted = counters.values().toArray(new Counter[]{});</span>
<span class="fc" id="L724">        Arrays.sort(sorted, (Counter a, Counter b) -&gt; {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (b.count &gt; a.count) {</span>
<span class="nc" id="L726">                return 1;</span>
            }
<span class="nc bnc" id="L728" title="All 2 branches missed.">            return b.count &lt; a.count ? -1 : 0;</span>
        });
<span class="fc" id="L730">        Book[] related = new Book[]{targetBook, targetBook, targetBook,</span>
            targetBook, targetBook};
<span class="pc bpc" id="L732" title="2 of 4 branches missed.">        for (j = 0; j &lt; 5 &amp;&amp; j &lt; sorted.length; j++) {</span>
<span class="nc" id="L733">            related[j] = sorted[j].book;</span>
        }
<span class="fc" id="L735">        targetBook.setRelated1(related[0]);</span>
<span class="fc" id="L736">        targetBook.setRelated2(related[1]);</span>
<span class="fc" id="L737">        targetBook.setRelated3(related[2]);</span>
<span class="fc" id="L738">        targetBook.setRelated4(related[3]);</span>
<span class="fc" id="L739">        targetBook.setRelated5(related[4]);</span>
<span class="fc" id="L740">    }</span>

    /**
     *
     * @param id
     * @return
     */
    public Cart getCart(int id) {
<span class="fc" id="L748">        return cartsById.get(id);</span>
    }

    /**
     *
     * @param now
     * @return
     */
    public Cart createCart(long now) {
<span class="fc" id="L757">        int id = cartsById.size();</span>
<span class="fc" id="L758">        Cart cart = new Cart(id, new Date(now));</span>
<span class="fc" id="L759">        cartsById.add(cart);</span>
<span class="fc" id="L760">        return cart;</span>
    }

    /**
     *
     * @param cId
     * @param bId
     * @param bIds
     * @param quantities
     * @param now
     * @return
     */
    public Cart updateCart(int cId, Integer bId, List&lt;Integer&gt; bIds,
                           List&lt;Integer&gt; quantities, long now) {
<span class="fc" id="L774">        Cart cart = getCart(cId);</span>

<span class="pc bpc" id="L776" title="1 of 2 branches missed.">        if (bId != null) {</span>
<span class="fc" id="L777">            cart.increaseLine(getBook(bId).get(), 1);</span>
        }

<span class="fc bfc" id="L780" title="All 2 branches covered.">        for (int i = 0; i &lt; bIds.size(); i++) {</span>
<span class="fc" id="L781">            cart.changeLine(booksById.get(bIds.get(i)), quantities.get(i));</span>
        }

<span class="fc" id="L784">        cart.setTime(new Date(now));</span>

<span class="fc" id="L786">        return cart;</span>
    }

    /**
     *
     * @param customerId
     * @param cartId
     * @param comment
     * @param ccType
     * @param ccNumber
     * @param ccName
     * @param ccExpiry
     * @param shipping
     * @param shippingDate
     * @param addressId
     * @param now
     * @return
     */
    public Order confirmBuy(int customerId, int cartId, String comment,
            String ccType, long ccNumber, String ccName, Date ccExpiry,
            String shipping, Date shippingDate, int addressId, long now) {
<span class="fc" id="L807">        Customer customer = getCustomer(customerId);</span>
<span class="fc" id="L808">        Cart cart = getCart(cartId);</span>
<span class="fc" id="L809">        Address shippingAddress = customer.getAddress();</span>
<span class="pc bpc" id="L810" title="1 of 2 branches missed.">        if (addressId != -1) {</span>
<span class="fc" id="L811">            shippingAddress = addressById.get(addressId);</span>
        }
<span class="fc" id="L813">        cart.getLines().stream().map((cartLine) -&gt; {</span>
<span class="fc" id="L814">            Book book = cartLine.getBook();</span>
<span class="fc" id="L815">            book.addStock(-cartLine.getQty());</span>
<span class="fc" id="L816">            return book;</span>
<span class="fc bfc" id="L817" title="All 2 branches covered.">        }).filter((book) -&gt; (book.getStock() &lt; 10)).forEachOrdered((book) -&gt; {</span>
<span class="fc" id="L818">            book.addStock(21);</span>
<span class="fc" id="L819">        });</span>
<span class="fc" id="L820">        CCTransaction ccTransact = new CCTransaction(ccType, ccNumber, ccName,</span>
<span class="fc" id="L821">                ccExpiry, &quot;&quot;, cart.total(customer.getDiscount()),</span>
<span class="fc" id="L822">                new Date(now), shippingAddress.getCountry());</span>
<span class="fc" id="L823">        return createOrder(customer, new Date(now), cart, comment, shipping,</span>
<span class="fc" id="L824">                shippingDate, &quot;Pending&quot;, customer.getAddress(),</span>
                shippingAddress, ccTransact);
    }

    public Order createOrder(Customer customer, Date date, Cart cart,
            String comment, String shipType, Date shipDate,
            String status, Address billingAddress, Address shippingAddress,
            CCTransaction cc) {
<span class="fc" id="L832">        int id = ordersById.size();</span>
<span class="fc" id="L833">        Order order = new Order(id, customer, date, cart, comment, shipType,</span>
                shipDate, status, billingAddress, shippingAddress, cc);
<span class="fc" id="L835">        ordersById.add(order);</span>
<span class="fc" id="L836">        ordersByCreation.addFirst(order);</span>
<span class="fc" id="L837">        customer.logOrder(order);</span>
<span class="fc" id="L838">        cart.clear();</span>
<span class="fc" id="L839">        return order;</span>
    }

    public Order getOrderById(int id){
<span class="pc bpc" id="L843" title="1 of 2 branches missed.">        if(id &gt;= ordersById.size())</span>
<span class="nc" id="L844">            return null;</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">        if(id &lt; 0)</span>
<span class="nc" id="L846">            return null;</span>
<span class="fc" id="L847">        return ordersById.get(id);</span>
    }

    public Order updateOrder(int id, String status) {
<span class="fc" id="L851">        Order order = getOrderById(id);</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">        if(order != null) {</span>
<span class="fc" id="L853">            order.setStatus(status);</span>
        }
<span class="fc" id="L855">        return order;</span>
    }

    public Order cancelOrder(int id) {
<span class="fc" id="L859">        Order order = getOrderById(id);</span>
<span class="pc bpc" id="L860" title="1 of 2 branches missed.">        if(order != null) {</span>
<span class="pc bpc" id="L861" title="1 of 2 branches missed.">            if (&quot;PENDING&quot;.equals(order.getStatus().toUpperCase())) {</span>
<span class="fc" id="L862">                order.setStatus(&quot;CANCELED&quot;);</span>
            }
        }
<span class="fc" id="L865">        return order;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>